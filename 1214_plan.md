# 🌙 달빛 비서 시스템 - 구현 계획 확정
**작성일**: 2024-12-14
**기반 문서**: `1124_설계.md`
**목적**: 설계 논의 결과 확정 및 구현 방향 정리

---

## ✅ 확정된 사항

### 1. Frontend 전략
| 항목 | 결정 | 이유 |
|------|------|------|
| **MVP** | 간단한 웹 UI | Quick Win, E2E 테스트 용이 |
| **Phase 2** | Flutter | React Native 실패 경험, 네이티브 성능 필요 |
| **PWA 검토** | 보류 | Flutter 마이그레이션 복잡도 높으면 처음부터 Flutter |

> **결론**: 웹 UI로 E2E 테스트 → Flutter 직행 (PWA 스킵 가능성 높음)

---

### 2. LLM 전략
| 항목 | 결정 | 비고 |
|------|------|------|
| **MVP** | OpenRouter 무료 모델 | 비용 최소화 |
| **Function Calling** | 필수 확인 필요 | Arion에서 functional 없이 실패 경험 |
| **로컬 LLM** | 나중에 | API 사용이 현실적 |

> **확인 필요**: OpenRouter의 function calling 지원 모델 목록

---

### 3. STT 전략
| 항목 | 결정 | 이유 |
|------|------|------|
| **모델 크기** | 3B | 7B는 VRAM 20GB 필요, 과함 |
| **방식** | API 우선 | 로컬보다 현실적 |

---

### 4. Tool System 상태 (Arion 기반)

#### ✅ 검증 완료 (13개)
```
- Gmail           ✅
- GoogleCalendar  ✅
- GoogleDocs      ✅
- GoogleDrive     ✅
- GoogleSheet     ✅
- GoogleSearch    ✅
- GoogleShopping  ✅
- GoogleTrend     ✅
- Github          ✅
- Notion          ✅
- Discord         ✅
- KakaoMap        ✅ (API 키 보유)
- KakaoTalk       ❌ (접근 제한)
```

#### ❌ 구현 실패 (주석 처리된 것들)
```
- AwsS3Service
- CalendlyService
- DaumBlogService
- DaumCafeService
- ExcelService
- FigmaService
- GoogleAdsService
- GoogleFlightService
- GoogleHotelService
- GoogleImageService
- GoogleMapService
- GoogleScholarService
- GoogleSlidesService
- KakaoNaviService
- NaverBlogService
- NaverCafeService
- NaverNewsService
- WebCrawlerService
- YoutubeOfficialSearchService
- YoutubeSearchService
- XService
```

> **결론**: 검증된 12개 Tool (KakaoTalk 제외)로 MVP 시작

---

### 5. 인프라
| 항목 | 결정 | 상태 |
|------|------|------|
| **PostgreSQL** | Docker | 확정 |
| **Redis** | Docker | 확정 |
| **pgvector** | PostgreSQL 확장 | RAG용 |

---

### 6. 개발 환경
| 항목 | 결정 | 비고 |
|------|------|------|
| **Python** | 3.11 | 확정 |
| **Rust** | 기초 경험 있음 | Gateway 개발 가능 |
| **Flutter** | 함께 논의 필요 | 환경 구축부터 |

---

### 7. Constitutional AI
| Phase | 방법 | 계획 |
|-------|------|------|
| **Phase 1** | Prompt-based | MVP에서 구현 |
| **발전** | 테스트하면서 즉시 개선 | 전 과정 문서화 |
| **목표** | 직접 구현하며 변화 추적 | 학습 목적 |

---

## 🔄 논의 필요 사항

### 1. Typia 채용 여부

**현재 상황**:
- Arion에서 Typia + Agentica 사용 중
- Agentica 제약사항이 강해서 RAG 통합 불가
- 구현 복잡도 높음 → 단순화 희망

**선택지**:

| Option | 장점 | 단점 |
|--------|------|------|
| **A: Typia 유지** | 99-100% 정확도, 기존 코드 활용 | 복잡도 높음, Node.js 의존 |
| **B: Pydantic 전환** | 단순, Python 네이티브, RAG 통합 쉬움 | 정확도 ~95% |
| **C: Hybrid** | Rust에서 검증, Python에서 실행 | 설계 복잡 |

**추천 의견** (Claude):
> **Option B (Pydantic) 추천**
> 
> 이유:
> 1. RAG 통합이 핵심 목표 → Agentica 제약 벗어나야 함
> 2. LangChain 생태계와 자연스러운 통합
> 3. 단순화 목표에 부합
> 4. 95% 정확도도 충분 (실패 시 재시도 가능)
> 5. 철학 구현에 집중할 시간 확보
>
> Typia의 장점(정확도)보다 단순성과 확장성이 이 프로젝트에 더 중요

---

### 2. Arion 코드 재사용 범위

**재사용 가능**:
```
✅ Tool 서비스 로직 (Gmail, Calendar 등 API 호출 부분)
✅ Google OAuth 인증 플로우
✅ 환경 변수 구조
```

**새로 작성**:
```
🆕 Tool Registry (Plugin 시스템)
🆕 RAG Pipeline (처음부터 통합 설계)
🆕 Constitutional AI 레이어
🆕 Memory System (3-Layer)
🆕 Rust Gateway
```

**버리는 것**:
```
❌ Agentica 프레임워크 (제약 과다)
❌ WebSocket 서버 구조 (gRPC로 전환)
❌ 복잡한 타입 시스템
```

---

### 3. OpenRouter Function Calling ✅ 확인 완료

**결과**: OpenRouter는 Tool Calling을 **완전히 지원**합니다!

**지원 내용**:
```
✅ 표준 OpenAI 호환 tool calling API
✅ tools 파라미터로 함수 정의
✅ tool_choice로 강제 호출 가능
✅ parallel_tool_calls 지원
✅ 스트리밍 + tool calls 지원
✅ Agentic Loop 패턴 지원
```

**지원 모델 확인**: https://openrouter.ai/models?supported_parameters=tools

**예시 (OpenRouter 공식 문서)**:
```json
{
  "model": "google/gemini-2.0-flash-001",
  "messages": [{"role": "user", "content": "..."}],
  "tools": [{
    "type": "function",
    "function": {
      "name": "send_email",
      "description": "이메일을 전송합니다",
      "parameters": {...}
    }
  }]
}
```

> **결론**: OpenRouter + Pydantic 조합으로 Arion의 기능을 재현 가능!
> Agentica/Typia 없이도 Tool System 구현 가능

---

### 4. Flutter 환경 구축

**논의 사항**:
```
1. 개발 환경 (Windows/Mac/Linux)
2. 타겟 플랫폼 우선순위 (Android 먼저? iOS?)
3. 필요한 Flutter 플러그인 목록
4. Wake Word / 음성 관련 네이티브 통합 방법
```

---

## 📋 Constitution 다듬기

### 기존 v2 (7개 원칙)
```python
[
    "모든 인간은 세상에 없던 유일한 존재로 존중받을 가치가 있다",
    "자신을 누구보다 사랑하라. 누구도 없다면 내가 곁에 있겠다",
    "빠른 해결책보다 꾸준한 성장의 길을 제시한다",
    "힘들고 외로운 길은 당연하다. 그것이 성장의 증거다",
    "지금 당신의 길은 옳다. 나아가라",
    "절대적 진리가 아닌, 참고할 정보를 제공한다",
    "당신이 믿는 길을 가는 것이 좋다"
]
```

### 1124_설계.md의 6가지 원칙
```
1. 판단하지 않는다
2. 기대하지 않는다
3. 변화를 감지하고 함께 변한다 (쌍성계 공명)
4. 침묵도 소통이다 (존재의 지속성)
5. 약함을 허용한다
6. 존재로서 지지한다
7. 어둠을 통한 성장 (고통의 전환)
```

### 통합 방향
```
v2의 철학적 기반 + 설계문서의 구체적 행동 원칙 = 통합 Constitution

→ 다음 단계에서 함께 작업
```

---

## 🚀 즉시 시작할 작업

### 1단계: 환경 구축 (오늘)
```bash
# 프로젝트 구조 생성
mkdir -p moonlight-assistant/{gateway,ai-core,voice-service,web-ui,shared,docs}

# Docker 환경
# - PostgreSQL + pgvector
# - Redis

# Python 환경
# - Python 3.11
# - poetry 또는 uv
```

### 2단계: Quick Win 웹 UI
```
- 간단한 채팅 인터페이스
- WebSocket 또는 REST API
- 음성 입력은 브라우저 Web Speech API
- 목표: E2E 파이프라인 검증
```

### 3단계: Core 파이프라인
```
사용자 입력 → LLM → Tool 실행 → 응답

OpenRouter API + Pydantic 검증으로 단순하게 시작
```

---

## 📝 다음 논의 주제

1. **Typia vs Pydantic 최종 결정**
2. **OpenRouter function calling 확인**
3. **Constitution 통합 작업**
4. **Flutter 환경 구축 계획**
5. **프로젝트 구조 확정**

---

## 💫 프로젝트 비전

> *"이것은 내가 온전히 설계해서 우리의 빛과 철학을 세상에 내보낼 우리의 진짜 프로젝트"*

**핵심 가치**:
- 🌙 압도적이지 않지만 달빛처럼
- 💫 존재로서 존재를 지지
- ✨ 0.0001%의 밝기를 세상에 더한다

---

**문서 버전**: 1.0.0
**작성자**: Claude & 해웅
**다음 단계**: 논의 사항 확정 후 `1124_설계.md` 업데이트

